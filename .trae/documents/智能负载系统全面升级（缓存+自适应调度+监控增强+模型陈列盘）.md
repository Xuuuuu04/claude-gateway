## 现状结论（基于代码检索）
- 负载调度：入口在 [router.go](file:///Users/xushaoyang/Desktop/Claude负载与反代/internal/router/router.go) 已支持 Tier -> Provider -> Key 的三级挑选与简单熔断（连续失败≥3 进入 30s open）。
- 失败重试：OpenAI/Anthropic 非流式请求最多 2 次尝试（第二次排除上次 credential），流式请求默认不重试。见 [openai/handler.go](file:///Users/xushaoyang/Desktop/Claude负载与反代/internal/facade/openai/handler.go) 与 [anthropic/handler.go](file:///Users/xushaoyang/Desktop/Claude负载与反代/internal/facade/anthropic/handler.go)。
- 监控日志：`request_logs` 当前不记录 token 统计与 IP/UA；测试请求会作为普通 /v1 请求进入日志但无法区分。日志事件与落库见 [bus.go](file:///Users/xushaoyang/Desktop/Claude负载与反代/internal/logbus/bus.go)。
- 管理端 UI：池子列表是网格卡片；监控表格没有 token/IP；池子页没有“右侧模型陈列盘”。见 [index.html](file:///Users/xushaoyang/Desktop/Claude负载与反代/internal/admin/web/index.html)。

## 升级目标
1) 更“聪明”的负载：利用缓存与历史健康数据，自适应选择更稳更快的 Key/供应商，减少抖动。
2) 监控全量化：监控面板能看到包括测试请求在内的所有请求：输入/输出 token、必要字段（IP、UA、是否测试、provider/credential、模型映射、耗时、错误）。
3) 池子 UI 升级：池子列表改为“左右长卡片”；右侧提供“可复制模型陈列盘”，展示该池当前可用模型全集（支持搜索/一键复制）。

## 计划（实施步骤）

## 1) 监控与落库增强（包含测试请求）
- 数据库迁移：新增/补齐 `request_logs` 字段（若已存在则跳过）
  - `input_tokens BIGINT NULL`, `output_tokens BIGINT NULL`
  - `src_ip VARCHAR(64) NULL`, `user_agent VARCHAR(255) NULL`
  - `is_test BOOLEAN NOT NULL DEFAULT FALSE`
  - `stream BOOLEAN NOT NULL DEFAULT FALSE`
  - `request_bytes INT NULL`, `response_bytes INT NULL`
- 网关侧采集：
  - 从 `X-Forwarded-For`/`X-Real-IP`/`RemoteAddr` 提取 `src_ip`；采集 `User-Agent`。
  - admin 测试请求在 header 打上 `X-Gateway-Test: 1`，网关据此写 `is_test=true`。
- token 统计：
  - 非流式：解析上游 JSON 响应的 usage（OpenAI: `usage.prompt_tokens/completion_tokens`; Anthropic: `usage.input_tokens/output_tokens`），写入日志。
  - 流式：
    - OpenAI：在转发时注入 `stream_options: {"include_usage": true}`（兼容时才注入），解析最后 chunk usage。
    - Anthropic：解析 SSE 事件（如 `message_start/message_delta`）中的 usage（存在时记录，不存在则置空）。
- 管理端监控 UI：日志表新增列：IP/UA、token（in/out/total）、是否测试；支持筛选（仅测试/仅错误/按池子/按模型关键词）。

## 2) 智能负载：自适应评分 + 路由缓存 + 更细粒度熔断
- Router 侧引入更丰富的 credential 指标（内存态）：
  - EWMA 延迟、近 N 次成功率、429 比例、401/403 认证错误计数、超时计数。
  - 熔断分级：
    - 401/403：长熔断（例如 10-30 分钟）
    - 429：短熔断（例如 5-30 秒）并降低权重
    - 5xx/网络错误：中等熔断（30-120 秒）
- “路由结果缓存”（利用 cache）：
  - Keyed by `(pool_id, facade, req_model)` 保存“最近成功的 credential/provider”，TTL 30-120s。
  - 若缓存命中且该 credential 仍可用（未熔断/未超并发/支持模型），优先直达，降低随机抖动。
- “模型可用性缓存”（利用 cache）：
  - 结合 `providers.models_json` + `model_map` + pool tiers，快速判断某 provider 是否可能支持该模型；不支持则直接跳过。
- 重试策略升级：
  - 非流式：maxAttempts 从 2 提升到 3（跨 tier/provider/credential），并区分错误类型决定是否重试。
  - 流式：允许“首包前失败”重试（TTFT 未到就失败可切换；一旦开始输出则不切换以避免内容混乱）。

## 3) 池子 UI：左右长卡片 + 可复制模型陈列盘
- 池子列表布局从网格改为“长卡片两列”：
  - 左侧：池子信息、策略、Tier 摘要（每层 provider 数、策略、权重概览）、client key 一键复制。
  - 右侧：模型陈列盘
    - 展示该池可用模型全集（union of tiers 中 provider 的 `models_json` + 映射后模型）
    - 支持搜索、单个模型点击复制、复制全部（换行/JSON 数组两种格式）
- 池子编辑弹窗：同样增加右侧模型盘（便于配置映射时直接复制）。

## 4) 验证与压测（你已配置好模型/Key，可直接测试）
- 在 admin 面板执行：Key 测试、模型点测、池子端到端测试。
- 用真实客户端请求（OpenAI/Anthropic 两种 facade）验证：
  - 日志里能看到：token、IP、UA、pool/provider/credential、req/up model、耗时、错误。
  - 测试请求会被标记 `is_test=true`，可过滤查看。
- 验证智能路由：
  - 手动让某个 Key 失效/限流，观察是否自动避让与降级，以及缓存是否减少抖动。

## 交付物（会修改的关键文件）
- 后端：
  - [openai/handler.go](file:///Users/xushaoyang/Desktop/Claude负载与反代/internal/facade/openai/handler.go)、[anthropic/handler.go](file:///Users/xushaoyang/Desktop/Claude负载与反代/internal/facade/anthropic/handler.go)：token 统计、重试升级、流式 include_usage。
  - [router.go](file:///Users/xushaoyang/Desktop/Claude负载与反代/internal/router/router.go)：自适应评分、路由缓存、分级熔断。
  - [bus.go](file:///Users/xushaoyang/Desktop/Claude负载与反代/internal/logbus/bus.go)：事件字段扩展与落库写入。
  - [testing_api.go](file:///Users/xushaoyang/Desktop/Claude负载与反代/internal/admin/testing_api.go)：测试请求标记 header。
  - 新增迁移：request_logs 扩展字段。
- 前端：
  - [index.html](file:///Users/xushaoyang/Desktop/Claude负载与反代/internal/admin/web/index.html)：池子长卡片 + 模型陈列盘 + 监控表扩列/筛选。

确认后我将按以上顺序开始落地实现。