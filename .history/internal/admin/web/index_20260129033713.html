<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <title>Claude Gateway Admin</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        claude: {
                            bg: '#f9f7f2',
                            card: '#ffffff',
                            text: '#1d1d19',
                            muted: '#666660',
                            accent: '#d97757',
                            border: '#e5e2d9',
                            hover: '#f0ede4'
                        }
                    },
                    fontFamily: {
                        serif: ['"Noto Serif SC"', 'serif'],
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        mono: ['"Fira Code"', 'monospace']
                    }
                }
            }
        }
    </script>
    <style>
        [v-cloak] { display: none; }
        body { background-color: #f9f7f2; color: #1d1d19; font-family: 'Inter', sans-serif; }
        .heading-serif { font-family: 'Noto Serif SC', serif; }
        .claude-shadow { box-shadow: 0 1px 3px rgba(0,0,0,0.05), 0 1px 2px rgba(0,0,0,0.1); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e5e2d9; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #d1cdc0; }
        input, select, textarea { background-color: white !important; }
    </style>
</head>
<body class="min-h-screen">
<div id="app" v-cloak class="flex flex-col min-h-screen">
    <!-- Header -->
    <header class="bg-claude-bg border-b border-claude-border sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
            <div class="flex items-center space-x-12">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-claude-accent rounded flex items-center justify-center text-white font-serif text-xl">C</div>
                    <h1 class="text-xl font-serif font-bold tracking-tight">Gateway Admin</h1>
                </div>
                <nav v-if="token" class="hidden md:flex items-center space-x-1">
                    <button v-for="t in tabs" :key="t.key" @click="currentTab = t.key"
                            :class="['px-4 py-2 rounded-full text-sm font-medium transition-all', 
                                    currentTab === t.key ? 'bg-claude-text text-white' : 'text-claude-muted hover:bg-claude-hover hover:text-claude-text']">
                        {{ t.name }}
                    </button>
                </nav>
            </div>
            <div v-if="token" class="flex items-center space-x-6">
                <div class="flex items-center space-x-2 text-xs text-claude-muted">
                    <span :class="['w-2 h-2 rounded-full', status === '已连接' ? 'bg-green-500' : 'bg-yellow-500 animate-pulse']"></span>
                    <span>{{ status }}</span>
                </div>
                <button @click="logout" class="text-sm font-medium text-claude-muted hover:text-claude-accent transition-colors">退出</button>
            </div>
        </div>
    </header>

    <!-- Main -->
    <main class="flex-1 max-w-7xl mx-auto w-full p-6 md:p-10">
        <!-- Login Panel -->
        <div v-if="!token" class="max-w-md mx-auto mt-20">
            <div class="bg-claude-card p-10 rounded-2xl border border-claude-border claude-shadow">
                <h2 class="text-3xl font-serif font-bold mb-2 text-center">欢迎回来</h2>
                <p class="text-claude-muted text-center mb-8 text-sm">请输入管理员令牌以继续管理您的网关</p>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold uppercase tracking-wider text-claude-muted mb-2">Admin Token</label>
                        <input v-model="loginToken" type="password" placeholder="••••••••" @keyup.enter="saveToken"
                               class="w-full px-4 py-3 bg-white border border-claude-border rounded-xl focus:ring-2 focus:ring-claude-accent focus:border-claude-accent outline-none transition-all">
                    </div>
                    <button @click="saveToken" 
                            class="w-full bg-claude-text text-white py-3 rounded-xl font-bold hover:opacity-90 active:scale-[0.98] transition-all shadow-sm">
                        验证并登录
                    </button>
                </div>
            </div>
        </div>

        <div v-else class="space-y-10">
            <!-- Pools Section -->
            <section v-if="currentTab === 'pools'" class="animate-fadeIn">
                <div class="flex justify-between items-end mb-8">
                    <div>
                        <h2 class="text-3xl font-serif font-bold mb-2">渠道池管理</h2>
                        <p class="text-claude-muted text-sm">管理您的入口 API Key 及其绑定的上游凭据池</p>
                    </div>
                    <button @click="editPool()" class="bg-claude-text text-white px-6 py-2.5 rounded-full text-sm font-bold hover:opacity-90 active:scale-95 transition-all shadow-sm">
                        + 创建新池子
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8">
                    <div v-for="p in pools" :key="p.id" class="bg-claude-card p-8 rounded-2xl border border-claude-border claude-shadow group hover:border-claude-accent transition-all">
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <h3 class="text-xl font-serif font-bold group-hover:text-claude-accent transition-colors">{{ p.name }}</h3>
                                <div class="mt-2 flex items-center space-x-2">
                                    <span class="text-[10px] font-mono bg-claude-bg text-claude-muted px-2 py-0.5 rounded border border-claude-border">#{{ p.id }}</span>
                                    <span :class="['px-2 py-0.5 rounded text-[10px] font-bold tracking-wider uppercase', p.enabled ? 'bg-green-50 text-green-700 border border-green-200' : 'bg-red-50 text-red-700 border border-red-200']">
                                        {{ p.enabled ? 'Active' : 'Disabled' }}
                                    </span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button @click="editPool(p)" class="p-2 text-claude-muted hover:text-claude-text"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></button>
                                <button @click="deleteItem('pools', p.id)" class="p-2 text-claude-muted hover:text-red-500"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                            </div>
                        </div>
                        
                        <div class="space-y-5">
                            <div>
                                <label class="block text-[10px] font-bold text-claude-muted uppercase tracking-widest mb-2">Client Key</label>
                                <div class="flex items-center group/key">
                                    <code class="text-xs bg-claude-bg text-claude-text px-3 py-2 rounded-lg flex-1 font-mono truncate border border-claude-border">{{ p.client_key }}</code>
                                    <button @click="copy(p.client_key)" class="ml-2 p-2 text-claude-muted hover:text-claude-accent transition-colors">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="pt-4 border-t border-claude-border flex justify-between items-center text-sm">
                                <div class="flex flex-col">
                                    <span class="text-[10px] uppercase font-bold text-claude-muted tracking-widest">策略</span>
                                    <span class="font-medium mt-0.5">{{ formatStrategy(p.strategy) }}</span>
                                </div>
                                <div class="flex flex-col items-end">
                                    <span class="text-[10px] uppercase font-bold text-claude-muted tracking-widest">凭据数</span>
                                    <span class="font-bold text-claude-accent mt-0.5">{{ p.credential_ids.length }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Providers Section -->
            <section v-if="currentTab === 'providers'" class="animate-fadeIn">
                <div class="flex justify-between items-end mb-8">
                    <div>
                        <h2 class="text-3xl font-serif font-bold mb-2">供应商配置</h2>
                        <p class="text-claude-muted text-sm">配置不同的 AI 模型供应商及其基准端点</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <input v-model="providerFilter" placeholder="搜索供应商/分组/类型/URL" class="w-64 px-4 py-2.5 bg-white border border-claude-border rounded-full text-sm outline-none focus:ring-2 focus:ring-claude-accent">
                        <button @click="editProvider()" class="bg-claude-text text-white px-6 py-2.5 rounded-full text-sm font-bold hover:opacity-90 active:scale-95 transition-all shadow-sm">
                            + 添加供应商
                        </button>
                    </div>
                </div>

                <div class="bg-claude-card rounded-2xl border border-claude-border claude-shadow overflow-hidden">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="bg-claude-bg/50 border-b border-claude-border">
                                <th class="px-8 py-4 text-[10px] font-bold text-claude-muted uppercase tracking-widest">分组 / 供应商</th>
                                <th class="px-8 py-4 text-[10px] font-bold text-claude-muted uppercase tracking-widest">基准端点 (Base URL)</th>
                                <th class="px-8 py-4 text-[10px] font-bold text-claude-muted uppercase tracking-widest">模型 / 映射</th>
                                <th class="px-8 py-4 text-[10px] font-bold text-claude-muted uppercase tracking-widest text-right">操作</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-claude-border">
                            <template v-for="g in groupedProviders" :key="g.name">
                                <tr class="bg-claude-bg/40">
                                    <td class="px-8 py-3 text-xs font-bold text-claude-muted" colspan="4">
                                        {{ g.name }} <span class="ml-2 text-[10px] font-mono text-claude-muted">({{ g.items.length }})</span>
                                    </td>
                                </tr>
                                <tr v-for="p in g.items" :key="p.id" class="hover:bg-claude-bg/30 transition-colors">
                                <td class="px-8 py-6">
                                    <div class="flex items-center space-x-3">
                                        <div :class="['w-10 h-10 rounded-xl flex items-center justify-center font-bold text-sm uppercase', 
                                                     p.type === 'anthropic' ? 'bg-orange-100 text-orange-700' : 'bg-green-100 text-green-700']">
                                            {{ p.type[0] }}
                                        </div>
                                        <div>
                                            <div class="font-bold text-sm">{{ p.display_name || p.type }}</div>
                                            <div class="text-[10px] font-mono text-claude-muted uppercase">ID: {{ p.id }}</div>
                                            <div class="text-[10px] text-claude-muted mt-0.5">{{ p.group_name || '未分组' }} · {{ p.type }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-8 py-6">
                                    <code class="text-xs text-claude-muted font-mono truncate max-w-xs block">{{ p.base_url }}</code>
                                </td>
                                <td class="px-8 py-6">
                                    <div class="flex flex-wrap gap-2">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-claude-bg text-claude-text border border-claude-border">
                                            {{ countModels(p.models_json) }} 模型
                                        </span>
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-claude-bg text-claude-text border border-claude-border">
                                            {{ countMapItems(p.model_map_json) }} 映射
                                        </span>
                                    </div>
                                </td>
                                <td class="px-8 py-6 text-right space-x-2">
                                    <button @click="manageCredentials(p)" class="text-xs font-bold text-claude-accent hover:underline px-2">凭据</button>
                                    <button @click="refreshModels(p)" class="text-xs font-bold text-claude-accent hover:underline px-2">拉取模型</button>
                                    <button @click="batchTestProvider(p)" class="text-xs font-bold text-claude-text hover:underline px-2">测试Key</button>
                                    <button @click="editProvider(p)" class="text-xs font-bold text-claude-text hover:underline px-2">编辑</button>
                                    <button @click="deleteItem('providers', p.id)" class="text-xs font-bold text-red-400 hover:text-red-600 px-2">删除</button>
                                </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Monitoring Section -->
            <section v-if="currentTab === 'logs'" class="flex flex-col h-[75vh] animate-fadeIn">
                <div class="flex justify-between items-end mb-6">
                    <div>
                        <h2 class="text-3xl font-serif font-bold mb-2">实时监控</h2>
                        <p class="text-claude-muted text-sm">查看网关正在处理的请求日志和上游分发详情</p>
                    </div>
                    <div class="flex space-x-3">
                        <button @click="fetchLogs" class="bg-white border border-claude-border text-claude-text px-4 py-2 rounded-full text-xs font-bold hover:bg-claude-hover transition-all">
                            刷新历史
                        </button>
                    </div>
                </div>

                <div class="flex-1 bg-claude-card rounded-2xl border border-claude-border claude-shadow overflow-hidden flex flex-col">
                    <div class="overflow-x-auto flex-1 custom-scrollbar">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-claude-bg/50 border-b border-claude-border sticky top-0 z-10">
                                <tr>
                                    <th class="px-6 py-4 text-[10px] font-bold text-claude-muted uppercase tracking-widest">时间</th>
                                    <th class="px-6 py-4 text-[10px] font-bold text-claude-muted uppercase tracking-widest">池子 / 密钥</th>
                                    <th class="px-6 py-4 text-[10px] font-bold text-claude-muted uppercase tracking-widest">模型 (Req → Up)</th>
                                    <th class="px-6 py-4 text-[10px] font-bold text-claude-muted uppercase tracking-widest">状态</th>
                                    <th class="px-6 py-4 text-[10px] font-bold text-claude-muted uppercase tracking-widest">延迟</th>
                                    <th class="px-6 py-4 text-[10px] font-bold text-claude-muted uppercase tracking-widest">错误详情</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-claude-border font-sans">
                                <tr v-for="l in logs" :key="l.id || l.ts" :class="l.status >= 400 ? 'bg-red-50/30' : 'hover:bg-claude-bg/20'">
                                    <td class="px-6 py-3 text-xs text-claude-muted whitespace-nowrap">{{ formatTime(l.ts || l.created_at) }}</td>
                                    <td class="px-6 py-3">
                                        <div class="font-bold text-claude-text text-xs">{{ getPoolName(l.pool_id) }}</div>
                                        <div class="text-[10px] font-mono text-claude-muted truncate w-24">...{{ l.client_key.slice(-6) }}</div>
                                    </td>
                                    <td class="px-6 py-3">
                                        <div class="flex items-center space-x-2 text-xs">
                                            <span class="font-medium text-claude-accent">{{ l.request_model || l.model }}</span>
                                            <span class="text-claude-muted">→</span>
                                            <span class="font-medium text-claude-muted">{{ l.upstream_model || '-' }}</span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-3">
                                        <span :class="['px-2 py-0.5 rounded text-[10px] font-bold border', 
                                                       l.status < 300 ? 'bg-green-50 text-green-700 border-green-200' : 
                                                       l.status < 400 ? 'bg-blue-50 text-blue-700 border-blue-200' : 
                                                       'bg-red-50 text-red-700 border-red-200']">
                                            {{ l.status }}
                                        </span>
                                    </td>
                                    <td class="px-6 py-3">
                                        <span :class="['text-xs font-mono font-medium', l.latency_ms > 1000 ? 'text-orange-500' : 'text-claude-muted']">
                                            {{ l.latency_ms }}ms
                                        </span>
                                    </td>
                                    <td class="px-6 py-3">
                                        <div class="text-[10px] text-red-500 font-mono truncate max-w-xs" :title="l.error">{{ l.error }}</div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Modal Backdrop -->
    <div v-if="modal" class="fixed inset-0 bg-claude-text/40 backdrop-blur-md flex items-center justify-center z-[100] p-6 animate-fadeIn">
        
        <!-- Pool Modal -->
        <div v-if="modal === 'pool'" class="bg-claude-card rounded-3xl shadow-2xl w-full max-w-2xl overflow-hidden border border-claude-border animate-slideUp">
            <div class="px-8 py-6 border-b border-claude-border bg-claude-bg/30 flex justify-between items-center">
                <h3 class="font-serif font-bold text-2xl">{{ form.id ? '编辑渠道池' : '创建新池子' }}</h3>
                <button @click="modal = null" class="text-claude-muted hover:text-claude-text transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="p-8 space-y-6 max-h-[65vh] overflow-y-auto custom-scrollbar">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-[10px] font-bold text-claude-muted uppercase tracking-widest mb-2">名称</label>
                        <input v-model="form.name" class="w-full px-4 py-2.5 bg-white border border-claude-border rounded-xl outline-none focus:ring-2 focus:ring-claude-accent transition-all">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-claude-muted uppercase tracking-widest mb-2">调度策略</label>
                        <select v-model="form.strategy" class="w-full px-4 py-2.5 bg-white border border-claude-border rounded-xl outline-none focus:ring-2 focus:ring-claude-accent transition-all appearance-none cursor-pointer">
                            <option value="weighted_rr">加权轮询 (Weighted RR)</option>
                            <option value="least_inflight">最少并发 (Least Inflight)</option>
                            <option value="priority_failover">优先级故障转移</option>
                            <option value="round_robin">轮询 (Round Robin)</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-claude-muted uppercase tracking-widest mb-2">Client Key (网关鉴权密钥)</label>
                    <div class="flex space-x-2">
                        <input v-model="form.client_key" class="flex-1 px-4 py-2.5 bg-white border border-claude-border rounded-xl font-mono text-xs outline-none focus:ring-2 focus:ring-claude-accent" placeholder="sk-...">
                        <button @click="form.client_key = generateKey()" class="px-4 text-xs font-bold text-claude-accent hover:underline">重新生成</button>
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-claude-muted uppercase tracking-widest mb-3">绑定上游凭据</label>
                    <div class="border border-claude-border rounded-2xl overflow-hidden bg-claude-bg/20">
                        <div v-for="p in providersWithCreds" :key="p.id" class="border-b border-claude-border last:border-0">
                            <div class="bg-claude-bg/50 px-4 py-2 text-[10px] font-bold text-claude-muted uppercase tracking-tighter">{{ p.type }} - {{ p.base_url }}</div>
                            <div class="p-3 grid grid-cols-1 sm:grid-cols-2 gap-2">
                                <label v-for="c in p.creds" :key="c.id" :class="['flex items-center space-x-3 p-2.5 border rounded-xl cursor-pointer transition-all', 
                                                                              form.credential_ids.includes(c.id) ? 'bg-claude-accent/10 border-claude-accent/30' : 'bg-white border-claude-border hover:border-claude-accent/30']">
                                    <input type="checkbox" v-model="form.credential_ids" :value="c.id" class="w-4 h-4 rounded text-claude-accent focus:ring-claude-accent">
                                    <div class="flex-1 min-w-0">
                                        <div class="text-xs font-bold truncate">{{ c.name }}</div>
                                        <div class="text-[9px] text-claude-muted font-mono uppercase">****{{ c.key_last4 }} | W:{{ c.weight }}</div>
                                    </div>
                                </label>
                            </div>
                            <div v-if="!p.creds.length" class="p-4 text-center text-xs text-claude-muted italic">该供应商下暂无凭据</div>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-claude-muted uppercase tracking-widest mb-2">模型映射规则 (JSON)</label>
                    <textarea v-model="form.model_map_json" rows="4" class="w-full px-4 py-3 bg-white border border-claude-border rounded-xl font-mono text-xs outline-none focus:ring-2 focus:ring-claude-accent" placeholder='{"gpt-4": "claude-3-opus"}'></textarea>
                </div>
                <div class="flex items-center space-x-3 p-4 bg-claude-bg/30 rounded-2xl border border-claude-border">
                    <input type="checkbox" v-model="form.enabled" id="pool-enabled" class="w-5 h-5 rounded text-claude-accent focus:ring-claude-accent cursor-pointer">
                    <label for="pool-enabled" class="text-sm font-bold cursor-pointer select-none">启用此渠道池</label>
                </div>
            </div>
            <div class="px-8 py-6 bg-claude-bg/30 border-t border-claude-border flex justify-end space-x-4">
                <button @click="modal = null" class="px-6 py-2.5 text-claude-muted font-bold hover:text-claude-text transition-colors">取消</button>
                <button @click="savePool" class="px-8 py-2.5 bg-claude-text text-white rounded-full font-bold hover:opacity-90 active:scale-95 transition-all shadow-md">保存配置</button>
            </div>
        </div>

        <!-- Provider Modal -->
        <div v-if="modal === 'provider'" class="bg-claude-card rounded-3xl shadow-2xl w-full max-w-lg overflow-hidden border border-claude-border animate-slideUp">
            <div class="px-8 py-6 border-b border-claude-border bg-claude-bg/30 flex justify-between items-center">
                <h3 class="font-serif font-bold text-2xl">{{ form.id ? '编辑供应商' : '添加新供应商' }}</h3>
                <button @click="modal = null" class="text-claude-muted hover:text-claude-text transition-colors">✕</button>
            </div>
            <div class="p-8 space-y-6">
                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <label class="block text-[10px] font-bold text-claude-muted uppercase tracking-widest mb-2">显示名称</label>
                        <input v-model="form.display_name" placeholder="例如：硅基主账号" class="w-full px-4 py-2.5 bg-white border border-claude-border rounded-xl text-sm outline-none focus:ring-2 focus:ring-claude-accent">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-claude-muted uppercase tracking-widest mb-2">分组/分类</label>
                        <input v-model="form.group_name" placeholder="例如：国内/海外/代理" class="w-full px-4 py-2.5 bg-white border border-claude-border rounded-xl text-sm outline-none focus:ring-2 focus:ring-claude-accent">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <label class="block text-[10px] font-bold text-claude-muted uppercase tracking-widest mb-2">类型</label>
                        <select v-model="form.type" class="w-full px-4 py-2.5 bg-white border border-claude-border rounded-xl outline-none focus:ring-2 focus:ring-claude-accent appearance-none cursor-pointer">
                            <option value="openai">OpenAI</option>
                            <option value="anthropic">Anthropic</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-claude-muted uppercase tracking-widest mb-2">状态</label>
                        <select v-model="form.enabled" class="w-full px-4 py-2.5 bg-white border border-claude-border rounded-xl outline-none focus:ring-2 focus:ring-claude-accent appearance-none cursor-pointer">
                            <option :value="true">启用</option>
                            <option :value="false">禁用</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-claude-muted uppercase tracking-widest mb-2">基准端点 (Base URL)</label>
                    <input v-model="form.base_url" placeholder="https://api.anthropic.com" class="w-full px-4 py-2.5 bg-white border border-claude-border rounded-xl outline-none font-mono text-sm focus:ring-2 focus:ring-claude-accent">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-claude-muted uppercase tracking-widest mb-2">默认请求头 (JSON)</label>
                    <textarea v-model="form.default_headers_json" rows="3" class="w-full px-4 py-3 bg-white border border-claude-border rounded-xl font-mono text-xs focus:ring-2 focus:ring-claude-accent"></textarea>
                </div>
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <label class="block text-[10px] font-bold text-claude-muted uppercase tracking-widest">默认模型映射</label>
                        <div class="inline-flex bg-white border border-claude-border rounded-full overflow-hidden">
                            <button @click="setMapMode('provider','table')" :class="['px-3 py-1 text-[10px] font-bold', form._modelMapMode !== 'json' ? 'bg-claude-text text-white' : 'text-claude-muted']">表格</button>
                            <button @click="setMapMode('provider','json')" :class="['px-3 py-1 text-[10px] font-bold', form._modelMapMode === 'json' ? 'bg-claude-text text-white' : 'text-claude-muted']">JSON</button>
                        </div>
                    </div>
                    <div v-if="form._modelMapMode !== 'json'" class="border border-claude-border rounded-2xl overflow-hidden">
                        <div class="bg-claude-bg/40 px-4 py-2 flex justify-between items-center">
                            <div class="text-[10px] font-bold text-claude-muted uppercase tracking-widest">请求模型 → 上游模型</div>
                            <button @click="addMapRow('provider')" class="text-xs font-bold text-claude-accent hover:underline">+ 添加</button>
                        </div>
                        <div class="divide-y divide-claude-border bg-white">
                            <div v-for="(r, idx) in form._modelMapRows" :key="idx" class="p-4 grid grid-cols-12 gap-3 items-center">
                                <input v-model="r.from" placeholder="例如: gpt-4o" class="col-span-5 px-3 py-2 border border-claude-border rounded-xl font-mono text-xs outline-none focus:ring-2 focus:ring-claude-accent">
                                <div class="col-span-1 text-center text-claude-muted">→</div>
                                <div class="col-span-5">
                                    <select v-if="getModelsArray(form.models_json).length" v-model="r.to" class="w-full px-3 py-2 border border-claude-border rounded-xl font-mono text-xs outline-none focus:ring-2 focus:ring-claude-accent bg-white">
                                        <option value="">请选择上游模型</option>
                                        <option v-for="m in getModelsArray(form.models_json)" :key="m" :value="m">{{ m }}</option>
                                    </select>
                                    <input v-else v-model="r.to" placeholder="例如: claude-3-5-sonnet-latest" class="w-full px-3 py-2 border border-claude-border rounded-xl font-mono text-xs outline-none focus:ring-2 focus:ring-claude-accent">
                                </div>
                                <button @click="removeMapRow('provider', idx)" class="col-span-1 text-red-400 hover:text-red-600 text-xs font-bold">删</button>
                            </div>
                            <div v-if="!form._modelMapRows || !form._modelMapRows.length" class="p-6 text-xs text-claude-muted">暂无映射，默认直通请求模型</div>
                        </div>
                    </div>
                    <textarea v-else v-model="form.model_map_json" rows="6" class="w-full px-4 py-3 bg-white border border-claude-border rounded-xl font-mono text-xs focus:ring-2 focus:ring-claude-accent"></textarea>
                </div>
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <label class="block text-[10px] font-bold text-claude-muted uppercase tracking-widest">模型列表</label>
                        <button @click="refreshModels(form)" class="text-xs font-bold text-claude-accent hover:underline">拉取模型</button>
                    </div>
                    <div class="bg-claude-bg/30 border border-claude-border rounded-2xl p-4">
                        <div class="flex items-center justify-between text-xs">
                            <div class="text-claude-muted font-mono">已缓存 {{ countModels(form.models_json) }} 个</div>
                            <div class="text-claude-muted font-mono" v-if="form.models_refreshed_at">{{ form.models_refreshed_at }}</div>
                        </div>
                        <div v-if="getModelsArray(form.models_json).length" class="mt-3 flex flex-wrap gap-2 max-h-24 overflow-y-auto custom-scrollbar">
                            <span v-for="m in getModelsArray(form.models_json).slice(0, 60)" :key="m" class="px-2 py-1 text-[10px] font-mono bg-white border border-claude-border rounded-lg">{{ m }}</span>
                            <span v-if="getModelsArray(form.models_json).length > 60" class="px-2 py-1 text-[10px] font-mono text-claude-muted">...{{ getModelsArray(form.models_json).length - 60 }} 更多</span>
                        </div>
                        <div v-else class="mt-2 text-xs text-claude-muted">未拉取到模型。可先录入并测试 Key，再点击“拉取模型”。</div>
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-claude-muted uppercase tracking-widest mb-2">备注</label>
                    <textarea v-model="form.notes" rows="2" class="w-full px-4 py-3 bg-white border border-claude-border rounded-xl text-sm focus:ring-2 focus:ring-claude-accent"></textarea>
                </div>
            </div>
            <div class="px-8 py-6 bg-claude-bg/30 border-t border-claude-border flex justify-end space-x-4">
                <button @click="modal = null" class="px-6 py-2.5 text-claude-muted font-bold hover:text-claude-text">取消</button>
                <button @click="saveProvider" class="px-8 py-2.5 bg-claude-text text-white rounded-full font-bold hover:opacity-90 shadow-md">保存</button>
            </div>
        </div>

        <!-- Credentials Modal -->
        <div v-if="modal === 'credentials'" class="bg-claude-card rounded-3xl shadow-2xl w-full max-w-5xl overflow-hidden border border-claude-border animate-slideUp">
            <div class="px-8 py-6 border-b border-claude-border bg-claude-bg/30 flex justify-between items-center">
                <div>
                    <h3 class="font-serif font-bold text-2xl">凭据库: {{ activeProvider.type }}</h3>
                    <p class="text-[10px] text-claude-muted font-mono uppercase mt-1">{{ activeProvider.base_url }}</p>
                </div>
                <button @click="modal = null" class="text-claude-muted hover:text-claude-text transition-colors">✕</button>
            </div>
            <div class="p-8 flex flex-col md:flex-row space-y-8 md:space-y-0 md:space-x-8 h-[65vh]">
                <!-- List -->
                <div class="flex-1 flex flex-col overflow-hidden">
                    <div class="mb-4 flex justify-between items-center">
                        <h4 class="text-[10px] font-bold text-claude-muted uppercase tracking-widest">已录入凭据</h4>
                        <span class="text-[10px] font-bold px-2 py-0.5 bg-claude-bg border border-claude-border rounded-full">{{ activeCredentials.length }}</span>
                    </div>
                    <div class="flex-1 overflow-y-auto border border-claude-border rounded-2xl divide-y divide-claude-border bg-claude-bg/10 custom-scrollbar">
                        <div v-for="c in activeCredentials" :key="c.id" class="p-4 hover:bg-white transition-colors flex justify-between items-center group">
                            <div>
                                <div class="font-bold text-sm">{{ c.name }}</div>
                                <div class="text-[10px] text-claude-muted font-mono mt-1">
                                    <span class="bg-claude-bg px-1.5 py-0.5 rounded border border-claude-border">****{{ c.key_last4 }}</span>
                                    <span class="ml-2">权重: {{ c.weight }}</span>
                                    <span v-if="c.concurrency_limit > 0" class="ml-2">并发: {{ c.concurrency_limit }}</span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button @click="editCredential(c)" class="text-xs font-bold text-claude-text hover:underline">编辑</button>
                                <button @click="deleteItem('credentials', c.id)" class="text-xs font-bold text-red-400 hover:text-red-600">删除</button>
                            </div>
                        </div>
                        <div v-if="!activeCredentials.length" class="h-full flex flex-col items-center justify-center p-10 text-claude-muted opacity-50">
                            <svg class="w-12 h-12 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path></svg>
                            <p class="text-sm">暂无 API 凭据</p>
                        </div>
                    </div>
                </div>
                <!-- Form -->
                <div class="w-full md:w-96 space-y-5 bg-claude-bg/50 p-6 rounded-3xl border border-claude-border">
                    <h4 class="font-serif font-bold text-lg">{{ credForm.id ? '更新凭据信息' : '添加 / 批量导入' }}</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-[10px] font-bold text-claude-muted uppercase tracking-widest mb-2">显示名称</label>
                            <input v-model="credForm.name" placeholder="例如: 个人主账号-1" class="w-full px-4 py-2.5 bg-white border border-claude-border rounded-xl text-sm outline-none focus:ring-2 focus:ring-claude-accent">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-claude-muted uppercase tracking-widest mb-2">
                                API Key{{ credForm.id ? '' : '(s)' }} 
                                <span v-if="!credForm.id" class="normal-case font-normal text-claude-muted ml-1">(一行一个支持批量)</span>
                            </label>
                            <textarea v-if="!credForm.id" v-model="credForm.api_key" rows="5" class="w-full px-4 py-3 bg-white border border-claude-border rounded-xl font-mono text-xs outline-none focus:ring-2 focus:ring-claude-accent" placeholder="sk-ant-...\nsk-ant-..."></textarea>
                            <input v-else v-model="credForm.api_key" placeholder="留空则不修改 Key" class="w-full px-4 py-2.5 bg-white border border-claude-border rounded-xl font-mono text-xs outline-none focus:ring-2 focus:ring-claude-accent">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[10px] font-bold text-claude-muted uppercase tracking-widest mb-2">负载权重</label>
                                <input v-model.number="credForm.weight" type="number" class="w-full px-4 py-2.5 bg-white border border-claude-border rounded-xl text-sm outline-none focus:ring-2 focus:ring-claude-accent">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-claude-muted uppercase tracking-widest mb-2">并发限制</label>
                                <input v-model.number="credForm.concurrency_limit" type="number" class="w-full px-4 py-2.5 bg-white border border-claude-border rounded-xl text-sm outline-none focus:ring-2 focus:ring-claude-accent" placeholder="0 表示不限">
                            </div>
                        </div>
                        <div class="pt-2">
                            <button @click="saveCredential" class="w-full py-3 bg-claude-text text-white rounded-full font-bold hover:opacity-90 active:scale-95 transition-all shadow-md">
                                {{ credForm.id ? '保存更改' : (credForm.api_key.includes('\n') ? '批量导入凭据' : '添加凭据') }}
                            </button>
                            <button v-if="credForm.id" @click="resetCredForm" class="w-full mt-3 text-xs font-bold text-claude-muted hover:text-claude-text">放弃修改</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const { createApp, ref, onMounted, computed, watch } = Vue;

createApp({
    setup() {
        const token = ref(localStorage.getItem('admin_token') || '');
        const loginToken = ref('');
        const currentTab = ref('pools');
        const tabs = [
            { key: 'pools', name: '渠道池' },
            { key: 'providers', name: '供应商' },
            { key: 'logs', name: '监控面板' }
        ];

        const pools = ref([]);
        const providers = ref([]);
        const credentials = ref([]);
        const logs = ref([]);
        const status = ref('正在连接...');

        const modal = ref(null);
        const form = ref({});
        const activeProvider = ref(null);
        const activeCredentials = ref([]);
        const credForm = ref({ weight: 1, concurrency_limit: 0, enabled: true });

        // Helper to safely count JSON items (fixes [object Object] SyntaxError)
        const countMapItems = (val) => {
            if (!val) return 0;
            try {
                const obj = typeof val === 'string' ? JSON.parse(val) : val;
                return obj ? Object.keys(obj).length : 0;
            } catch (e) { return 0; }
        };

        const formatStrategy = (s) => {
            const m = {
                'weighted_rr': '加权轮询',
                'least_inflight': '最少并发',
                'priority_failover': '优先级故障转移',
                'round_robin': '轮询'
            };
            return m[s] || s;
        };

        const generateKey = () => 'sk-' + Math.random().toString(36).slice(2, 18);

        const api = async (path, opt = {}) => {
            opt.headers = { 
                ...opt.headers, 
                'Authorization': 'Bearer ' + token.value,
                'Content-Type': 'application/json'
            };
            const resp = await fetch('/admin/api' + path, opt);
            if (resp.status === 401) { logout(); throw 'unauthorized'; }
            if (resp.status === 204) return null;
            const data = await resp.json();
            if (!resp.ok) throw data.error || 'API Error';
            return data;
        };

        const fetchAll = async () => {
            if (!token.value) return;
            try {
                const [p, pr, cr] = await Promise.all([api('/pools'), api('/providers'), api('/credentials')]);
                pools.value = p;
                providers.value = pr;
                credentials.value = cr;
                status.value = '已连接';
            } catch (e) { 
                console.error(e); 
                status.value = '连接异常';
            }
        };

        const fetchLogs = async () => {
            try { logs.value = await api('/logs'); } catch(e){}
        };

        const providersWithCreds = computed(() => {
            return providers.value.map(p => ({
                ...p,
                creds: credentials.value.filter(c => c.provider_id === p.id)
            }));
        });

        // SSE for real-time logs
        let es = null;
        const startSSE = () => {
            if (es) es.close();
            es = new EventSource('/admin/api/logs/stream?token=' + token.value);
            es.onmessage = (e) => {
                const ev = JSON.parse(e.data);
                logs.value.unshift(ev);
                if (logs.value.length > 200) logs.value.pop();
            };
            es.onerror = () => { status.value = '重连中...'; };
            es.onopen = () => { status.value = '实时监控中'; };
        };

        // Pool Management
        const editPool = (p) => {
            form.value = p ? JSON.parse(JSON.stringify(p)) : { name: '', client_key: generateKey(), strategy: 'round_robin', credential_ids: [], model_map_json: '{}', enabled: true };
            if (typeof form.value.model_map_json !== 'string') form.value.model_map_json = JSON.stringify(form.value.model_map_json || {}, null, 2);
            modal.value = 'pool';
        };
        const savePool = async () => {
            try {
                const body = { ...form.value, model_map_json: JSON.parse(form.value.model_map_json || '{}') };
                const method = body.id ? 'PUT' : 'POST';
                const url = body.id ? '/pools/' + body.id : '/pools';
                await api(url, { method, body: JSON.stringify(body) });
                modal.value = null; fetchAll();
            } catch(e) { alert('保存失败: ' + e); }
        };

        // Provider Management
        const editProvider = (p) => {
            form.value = p ? JSON.parse(JSON.stringify(p)) : { type: 'openai', base_url: '', default_headers_json: '{}', model_map_json: '{}', enabled: true };
            ['default_headers_json', 'model_map_json'].forEach(k => {
                if (typeof form.value[k] !== 'string') form.value[k] = JSON.stringify(form.value[k] || {}, null, 2);
            });
            modal.value = 'provider';
        };
        const saveProvider = async () => {
            try {
                const body = { ...form.value };
                ['default_headers_json', 'model_map_json'].forEach(k => { body[k] = JSON.parse(body[k] || '{}'); });
                const method = body.id ? 'PUT' : 'POST';
                const url = body.id ? '/providers/' + body.id : '/providers';
                await api(url, { method, body: JSON.stringify(body) });
                modal.value = null; fetchAll();
            } catch(e) { alert('保存失败: ' + e); }
        };

        // Credentials Management
        const manageCredentials = async (p) => {
            activeProvider.value = p;
            activeCredentials.value = credentials.value.filter(c => c.provider_id === p.id);
            resetCredForm();
            modal.value = 'credentials';
        };
        const resetCredForm = () => {
            credForm.value = { provider_id: activeProvider.value.id, weight: 1, concurrency_limit: 0, enabled: true, name: '', api_key: '' };
        };
        const editCredential = (c) => {
            credForm.value = JSON.parse(JSON.stringify(c));
            credForm.value.api_key = ''; // Never show old key
        };
        const saveCredential = async () => {
            try {
                if (!credForm.value.id && credForm.value.api_key.includes('\n')) {
                    const keys = credForm.value.api_key.split('\n').map(k => k.trim()).filter(k => k);
                    const items = keys.map((k, i) => ({
                        name: credForm.value.name ? (credForm.value.name + '-' + (i+1)) : (activeProvider.value.type + '-' + (i+1)),
                        api_key: k,
                        weight: credForm.value.weight,
                        concurrency_limit: credForm.value.concurrency_limit,
                        enabled: true
                    }));
                    await api('/credentials/bulk', { method: 'POST', body: JSON.stringify({ provider_id: activeProvider.value.id, items }) });
                } else {
                    const method = credForm.value.id ? 'PUT' : 'POST';
                    const url = credForm.value.id ? '/credentials/' + credForm.value.id : '/credentials';
                    await api(url, { method, body: JSON.stringify(credForm.value) });
                }
                const cr = await api('/credentials'); 
                credentials.value = cr;
                activeCredentials.value = credentials.value.filter(c => c.provider_id === activeProvider.value.id);
                resetCredForm();
            } catch(e) { alert('保存失败: ' + e); }
        };

        const deleteItem = async (type, id) => {
            if (!confirm('此操作不可逆，确定要删除吗?')) return;
            try {
                await api('/' + type + '/' + id, { method: 'DELETE' });
                fetchAll();
                if (type === 'credentials' && activeProvider.value) {
                    activeCredentials.value = activeCredentials.value.filter(c => c.id !== id);
                }
            } catch(e) { alert('删除失败: ' + e); }
        };

        const saveToken = () => {
            let t = loginToken.value.trim();
            if (t.startsWith('Bearer ')) t = t.substring(7).trim();
            if (!t) return;
            token.value = t; 
            localStorage.setItem('admin_token', token.value); 
            fetchAll(); 
        };
        const logout = () => { token.value = ''; localStorage.removeItem('admin_token'); if(es) es.close(); };
        const copy = (txt) => { 
            navigator.clipboard.writeText(txt); 
            // Minimal toast/alert could be added here
        };
        const formatTime = (ts) => {
            if (!ts) return '-';
            const d = new Date(ts);
            return d.getHours().toString().padStart(2, '0') + ':' + 
                   d.getMinutes().toString().padStart(2, '0') + ':' + 
                   d.getSeconds().toString().padStart(2, '0');
        };
        const getPoolName = (id) => pools.value.find(p => p.id === id)?.name || ('池 #' + id);

        watch(currentTab, (v) => { 
            if(v === 'logs') { startSSE(); fetchLogs(); } 
            else if(es) { es.close(); es = null; } 
        });

        onMounted(() => { 
            if(token.value) { 
                fetchAll(); 
                if(currentTab.value === 'logs') startSSE(); 
            } 
        });

        return {
            token, loginToken, saveToken, logout, tabs, currentTab,
            pools, providers, credentials, logs, status, modal, form, activeProvider, activeCredentials, credForm,
            fetchAll, fetchLogs, providersWithCreds, editPool, savePool, editProvider, saveProvider,
            manageCredentials, resetCredForm, editCredential, saveCredential, deleteItem,
            copy, formatTime, getPoolName, countMapItems, formatStrategy, generateKey
        };
    }
}).mount('#app');
</script>
</body>
</html>
