# 实施计划

## 1. 数据库架构调整
### 扩展 Pools 表结构
- 创建新的迁移文件 `0006_pool_tiers.sql`。
- 为 `pools` 表添加 `tiers_json` 字段，用于存储多梯度供应商配置。
- 结构示例：`[{"priority": 0, "strategy": "weighted_rr", "items": [{"provider_id": 1, "weight": 10}]}]`。

## 2. 后端路由引擎重构 ([router.go](file:///Users/xushaoyang/Desktop/Claude%E8%B4%9F%E8%BD%BD%E4%B8%8E%E5%8F%8D%E4%BB%A3/internal/router/router.go))
### 实现三级调度算法
- **第一级：梯度 (Tier)**：按优先级从高到低尝试。
- **第二级：供应商 (Provider)**：在同一梯度内根据策略（权重、随机、最小并发）选择。
- **第三级：凭据 (Key)**：在供应商内部进行 Key 自动轮询。
### 智能重试与熔断
- 如果 Key 报错（如 429/5xx），自动在同 Provider 下尝试其他 Key。
- 如果 Provider 所有 Key 失效，则在同 Tier 下尝试其他 Provider。
- 记录失败频率，实现动态熔断（Circuit Breaker）和自动恢复。

## 3. 管理端 UI 深度优化 ([index.html](file:///Users/xushaoyang/Desktop/Claude%E8%B4%9F%E8%BD%BD%E4%B8%8E%E5%8F%8D%E4%BB%A3/internal/admin/web/index.html))
### 可视化梯度编辑器
- 在渠道池编辑弹窗中，新增“梯度配置”面板。
- 支持动态添加/删除梯度容器。
- 提供供应商选择列表，支持一键加入特定梯度并设置权重。
- 增强视觉反馈：通过颜色和线条展示主备降级关系。

## 4. 验证与测试
- 模拟高优先级梯度全部失效，验证请求是否无感降级到备份梯度。
- 验证多 Key 供应商在部分 Key 失效时的内部切换逻辑。
